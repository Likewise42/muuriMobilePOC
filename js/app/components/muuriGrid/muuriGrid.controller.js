"use strict";

define(['../../muuri', '../../constants', '../../env', '../../autoid', '../../lifecycleHelper', '../../elementSize', './itemDimensions'], function (Muuri, constants, env, AutoId, LifecycleHelper, ElementSizeWatcher, itemDimensions) {
  'use strict';

  var itemAutoId = new AutoId();
  var itemHooks = new LifecycleHelper();
  /**
   * Attempt to read a data attribute value, returning undefined if none is found
   * @param {*} gridItem a Muuri.GridItem
   * @param {string} attributeName the name of the data attribute
   * @param {Function} [resuscitator] an optional resuscitation function that will be executed before returning the value
   * @returns {*} The raw, resuscitated, or undefined value (if no data attribute was found by the specified name)
   */

  var getGridItemDataAttribute = function getGridItemDataAttribute(gridItem, attributeName, resuscitator) {
    if (gridItem && angular.isFunction(gridItem.getElement)) {
      var value = gridItem.getElement().dataset[attributeName];
      return angular.isFunction(resuscitator) ? resuscitator(value) : value;
    }

    return undefined;
  };

  var name = 'muuridemo.components.muuriGrid.controller';
  var inject = ['$element', '$log'];

  function MuuriGrid($element, $log) {
    var _this = this;

    this.canDrag = true;
    this.editButtonText = 'Disable Edit Mode';
    this.availableGrids = [];

    this.$onInit = function () {
      //set up the muuri grid, using the grid element as the base 
      _this.grid = new Muuri($element[0].querySelector('.dashboard__grid'), {
        items: '.item',
        //include all of the items for the grid
        dragEnabled: _this.canDrag,
        //make sure you can drag
        dragSort: function dragSort() {
          return _this.availableGrids;
        },
        dragStartPredicate: function dragStartPredicate(item, event) {
          //if dragging is disabled then prevent the drag
          if (!_this.canDrag) {
            return false;
          } //if drag is enabled then do the default


          return Muuri.ItemDrag.defaultStartPredicate(item, event);
        },
        layout: {
          fillGaps: true //tells the default layout to not leave gaps whenever possible

        }
      });

      _this.grid.on('remove', function (items) {
        items.forEach(function (gridItem) {
          var itemId = getGridItemDataAttribute(gridItem, 'gridItemId');
          itemHooks.cleanup(itemId);
        });
      });

      _this.availableGrids.push(_this.grid);
    };

    this.$onDestroy = function () {
      if (_this.grid) {
        var elements = _this.grid.getItems();

        if (elements && elements.length) {
          _this.grid.remove(elements, {
            removeElements: true,
            layout: false
          });
        }

        _this.grid.destroy();

        _this.grid = null;
      }
    };

    var createGridItemContent = function createGridItemContent(tileContent) {
      //create the content element
      var contentElement = document.createElement('DIV');

      if (tileContent.type == 'Text') {
        contentElement.appendChild(document.createTextNode(tileContent.data));
      } else {
        var msg = 'We only support text right now';
        contentElement.appendChild(document.createTextNode(msg));

        if (env.LOG_LEVEL >= constants.LOG_LEVEL.WARN) {
          $log.warn(msg);
        }
      }

      return contentElement;
    };
    /**
     * Wrap the specified content into a set of grid item DOM elements
     * @param {string} height the requested height of the element
     * @param {string} width the requested width of the element
     * @param  {...HTMLElement} elements the elements to wrap in this grid item
     */


    var wrapGridItemContent = function wrapGridItemContent(height, width) {
      //get params and store them in local variables
      var tileHeight = height || 'XS';
      var tileWidth = width || 'S';
      var gridItemId = itemAutoId.next(); //create the new tile and give it the necessary css classes

      var gridItem = document.createElement('DIV');
      gridItem.classList.add('item', 'w' + tileWidth, 'h' + tileHeight); //create the element that will wrap the content

      var gridItemInner = document.createElement('DIV');
      gridItemInner.classList.add('item-content'); //append the content to the content wrapper, then append the content wrapper to the new tile

      gridItem.appendChild(gridItemInner);
      gridItem.dataset.gridItemId = gridItemId; // add all supplied elements to the inner node

      for (var _len = arguments.length, elements = new Array(_len > 2 ? _len - 2 : 0), _key = 2; _key < _len; _key++) {
        elements[_key - 2] = arguments[_key];
      }

      elements.forEach(function (e) {
        return gridItemInner.appendChild(e);
      });
      return {
        root: gridItem,
        inner: gridItemInner,
        id: gridItemId
      };
    };

    var buildNewGridItem = function buildNewGridItem(height, width, tileContent) {
      var heightButton = document.createElement('button');
      heightButton.innerText = 'Change height';
      var content = createGridItemContent(tileContent);
      var gridItem = wrapGridItemContent(height, width, content, heightButton);
      return {
        id: gridItem.id,
        root: gridItem.root,
        inner: gridItem.inner,
        button: heightButton
      };
    };
    /**
     * Set the order value on the provided grid item
     * @param {number} order The specified order
     * @param {HTMLElement} element The grid item element
     * @returns {void}
     */


    var setGridItemOrder = function setGridItemOrder(order, element) {
      // determine the correct value of the "order" argument because the specified value was not valid
      if (order == null || isNaN(order) || !angular.isNumber(order)) {
        var numItems = _this.grid.getItems().length;

        order = numItems - 1;
      } // set the data-order attribute value for the grid item


      element.dataset.order = '' + order;
    };

    var attachDemoResize = function attachDemoResize(gridItem) {
      // setup the demo resize button
      var resizeHandler = function resizeHandler() {
        var needsRefresh = itemDimensions.incrementGridItemHeight(gridItem.root);

        if (needsRefresh) {
          _this.grid.refreshItems([gridItem.root]);

          _this.grid.layout();
        }
      };

      gridItem.button.addEventListener('click', resizeHandler);
      itemHooks.register(gridItem.id, function () {
        gridItem.button.removeEventListener('click', resizeHandler);
      });
    };

    var setupDemoResizeDetection = function setupDemoResizeDetection(gridItem) {
      if (_this.gridType === 'display-grid') {
        var grower = document.createElement('div');
        grower.classList.add('dashboard__height-demo-subject');
        gridItem.inner.appendChild(grower);
        var watcher = new ElementSizeWatcher(grower);
        var subscription = watcher.watch(function () {
          if (gridItem.inner.scrollHeight > gridItem.inner.offsetHeight) {
            var needsRefresh = itemDimensions.setBestHeight(gridItem.root, gridItem.inner.scrollHeight);

            if (needsRefresh) {
              _this.grid.refreshItems([gridItem.root]);

              _this.grid.layout();
            }
          }
        });
        itemHooks.register(gridItem.id, function () {
          subscription.unsubscribe();
          watcher.destroy();
        });
      }
    };

    var destroyDragObjects = function destroyDragObjects() {
      _this.grid.getItems().forEach(function (item) {
        if (!item._drag) return;

        item._drag.destroy();

        item._drag = null;
      });
    };

    var createDragObjects = function createDragObjects() {
      _this.grid.getItems().forEach(function (item) {
        if (item._drag) return;
        item._drag = new Muuri.ItemDrag(item);
      });
    };
    /**
     * height: Extra Small, Small, Medium, Large, Extra Large
     * width: Small, Medium, Large
     * content: The content to be loaded. An object with type and data properties.
     */


    this.addTile = function (height, width, content, order, suspendLayout) {
      var tileContent = {};

      if (content) {
        tileContent = content;
      } else {
        tileContent = {
          type: 'Text',
          data: 'Dummy Data To Display'
        };
      }

      var gridItem = buildNewGridItem(height, width, tileContent);
      setGridItemOrder(order, gridItem.root);
      attachDemoResize(gridItem);
      setupDemoResizeDetection(gridItem); //actually add the new tile to the muuri grid, at the end, without performing layout

      _this.grid.add(gridItem.root, {
        index: -1,
        layout: false
      });

      _this.grid.sort(function (a, b) {
        var orderA = getGridItemDataAttribute(a, 'order', parseInt);
        var orderB = getGridItemDataAttribute(b, 'order', parseInt);
        return orderA - orderB;
      }); // if the layout is not suspended, perform layout after the sort


      if (!suspendLayout) {
        _this.grid.layout();
      }
    }; //toggle if you can drag items in the grid


    this.toggleEdit = function () {
      _this.canDrag = !_this.canDrag;

      if (_this.canDrag) {
        createDragObjects();
        _this.editButtonText = 'Disable Edit Mode';
      } else {
        destroyDragObjects();
        _this.editButtonText = 'Enable Edit Mode';
      }
    };
  }

  MuuriGrid.$inject = inject;
  MuuriGrid.controllerName = name;
  return MuuriGrid;
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL2h0bWwvanMvYXBwL2NvbXBvbmVudHMvbXV1cmlHcmlkL211dXJpR3JpZC5jb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbImRlZmluZSIsIk11dXJpIiwiY29uc3RhbnRzIiwiZW52IiwiQXV0b0lkIiwiTGlmZWN5Y2xlSGVscGVyIiwiRWxlbWVudFNpemVXYXRjaGVyIiwiaXRlbURpbWVuc2lvbnMiLCJpdGVtQXV0b0lkIiwiaXRlbUhvb2tzIiwiZ2V0R3JpZEl0ZW1EYXRhQXR0cmlidXRlIiwiZ3JpZEl0ZW0iLCJhdHRyaWJ1dGVOYW1lIiwicmVzdXNjaXRhdG9yIiwiYW5ndWxhciIsImlzRnVuY3Rpb24iLCJnZXRFbGVtZW50IiwidmFsdWUiLCJkYXRhc2V0IiwidW5kZWZpbmVkIiwibmFtZSIsImluamVjdCIsIk11dXJpR3JpZCIsIiRlbGVtZW50IiwiJGxvZyIsImNhbkRyYWciLCJlZGl0QnV0dG9uVGV4dCIsImF2YWlsYWJsZUdyaWRzIiwiJG9uSW5pdCIsImdyaWQiLCJxdWVyeVNlbGVjdG9yIiwiaXRlbXMiLCJkcmFnRW5hYmxlZCIsImRyYWdTb3J0IiwiZHJhZ1N0YXJ0UHJlZGljYXRlIiwiaXRlbSIsImV2ZW50IiwiSXRlbURyYWciLCJkZWZhdWx0U3RhcnRQcmVkaWNhdGUiLCJsYXlvdXQiLCJmaWxsR2FwcyIsIm9uIiwiZm9yRWFjaCIsIml0ZW1JZCIsImNsZWFudXAiLCJwdXNoIiwiJG9uRGVzdHJveSIsImVsZW1lbnRzIiwiZ2V0SXRlbXMiLCJsZW5ndGgiLCJyZW1vdmUiLCJyZW1vdmVFbGVtZW50cyIsImRlc3Ryb3kiLCJjcmVhdGVHcmlkSXRlbUNvbnRlbnQiLCJ0aWxlQ29udGVudCIsImNvbnRlbnRFbGVtZW50IiwiZG9jdW1lbnQiLCJjcmVhdGVFbGVtZW50IiwidHlwZSIsImFwcGVuZENoaWxkIiwiY3JlYXRlVGV4dE5vZGUiLCJkYXRhIiwibXNnIiwiTE9HX0xFVkVMIiwiV0FSTiIsIndhcm4iLCJ3cmFwR3JpZEl0ZW1Db250ZW50IiwiaGVpZ2h0Iiwid2lkdGgiLCJ0aWxlSGVpZ2h0IiwidGlsZVdpZHRoIiwiZ3JpZEl0ZW1JZCIsIm5leHQiLCJjbGFzc0xpc3QiLCJhZGQiLCJncmlkSXRlbUlubmVyIiwiZSIsInJvb3QiLCJpbm5lciIsImlkIiwiYnVpbGROZXdHcmlkSXRlbSIsImhlaWdodEJ1dHRvbiIsImlubmVyVGV4dCIsImNvbnRlbnQiLCJidXR0b24iLCJzZXRHcmlkSXRlbU9yZGVyIiwib3JkZXIiLCJlbGVtZW50IiwiaXNOYU4iLCJpc051bWJlciIsIm51bUl0ZW1zIiwiYXR0YWNoRGVtb1Jlc2l6ZSIsInJlc2l6ZUhhbmRsZXIiLCJuZWVkc1JlZnJlc2giLCJpbmNyZW1lbnRHcmlkSXRlbUhlaWdodCIsInJlZnJlc2hJdGVtcyIsImFkZEV2ZW50TGlzdGVuZXIiLCJyZWdpc3RlciIsInJlbW92ZUV2ZW50TGlzdGVuZXIiLCJzZXR1cERlbW9SZXNpemVEZXRlY3Rpb24iLCJncmlkVHlwZSIsImdyb3dlciIsIndhdGNoZXIiLCJzdWJzY3JpcHRpb24iLCJ3YXRjaCIsInNjcm9sbEhlaWdodCIsIm9mZnNldEhlaWdodCIsInNldEJlc3RIZWlnaHQiLCJ1bnN1YnNjcmliZSIsImRlc3Ryb3lEcmFnT2JqZWN0cyIsIl9kcmFnIiwiY3JlYXRlRHJhZ09iamVjdHMiLCJhZGRUaWxlIiwic3VzcGVuZExheW91dCIsImluZGV4Iiwic29ydCIsImEiLCJiIiwib3JkZXJBIiwicGFyc2VJbnQiLCJvcmRlckIiLCJ0b2dnbGVFZGl0IiwiJGluamVjdCIsImNvbnRyb2xsZXJOYW1lIl0sIm1hcHBpbmdzIjoiOztBQUFBQSxNQUFNLENBQUMsQ0FDSCxhQURHLEVBRUgsaUJBRkcsRUFHSCxXQUhHLEVBSUgsY0FKRyxFQUtILHVCQUxHLEVBTUgsbUJBTkcsRUFPSCxrQkFQRyxDQUFELEVBUUgsVUFDQ0MsS0FERCxFQUVDQyxTQUZELEVBR0NDLEdBSEQsRUFJQ0MsTUFKRCxFQUtDQyxlQUxELEVBTUND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S2tGLFVBQUwsR0FBa0IsWUFBTTtBQUNwQixNQUFBLEtBQUksQ0FBQ2hHLE9BQUwsR0FBZSxDQUFDLEtBQUksQ0FBQ0EsT0FBckI7O0FBQ0EsVUFBSSxLQUFJLENBQUNBLE9BQVQsRUFBa0I7QUFDZHNGLFFBQUFBLGlCQUFpQjtBQUNqQixRQUFBLEtBQUksQ0FBQ3JGLGNBQUwsR0FBc0IsbUJBQXRCO0FBQ0gsT0FIRCxNQUdPO0FBQ0htRixRQUFBQSxrQkFBa0I7QUFDbEIsUUFBQSxLQUFJLENBQUNuRixjQUFMLEdBQXNCLGtCQUF0QjtBQUNIO0FBQ0osS0FURDtBQVVIOztBQUVESixFQUFBQSxTQUFTLENBQUNvRyxPQUFWLEdBQW9CckcsTUFBcEI7QUFDQUMsRUFBQUEsU0FBUyxDQUFDcUcsY0FBVixHQUEyQnZHLElBQTNCO0FBQ0EsU0FBT0UsU0FBUDtBQUNILENBelJLLENBQU4iLCJzb3VyY2VzQ29udGVudCI6WyJkZWZpbmUoW1xyXG4gICAgJy4uLy4uL211dXJpJyxcclxuICAgICcuLi8uLi9jb25zdGFudHMnLFxyXG4gICAgJy4uLy4uL2VudicsXHJcbiAgICAnLi4vLi4vYXV0b2lkJyxcclxuICAgICcuLi8uLi9saWZlY3ljbGVIZWxwZXInLFxyXG4gICAgJy4uLy4uL2VsZW1lbnRTaXplJyxcclxuICAgICcuL2l0ZW1EaW1lbnNpb25zJ1xyXG5dLCBmdW5jdGlvbiAoXHJcbiAgICBNdXVyaSxcclxuICAgIGNvbnN0YW50cyxcclxuICAgIGVudixcclxuICAgIEF1dG9JZCxcclxuICAgIExpZmVjeWNsZUhlbHBlcixcclxuICAgIEVsZW1lbnRTaXplV2F0Y2hlcixcclxuICAgIGl0ZW1EaW1lbnNpb25zXHJcbikge1xyXG4gICAgJ3VzZSBzdHJpY3QnO1xyXG5cclxuICAgIGNvbnN0IGl0ZW1BdXRvSWQgPSBuZXcgQXV0b0lkKCk7XHJcbiAgICBjb25zdCBpdGVtSG9va3MgPSBuZXcgTGlmZWN5Y2xlSGVscGVyKCk7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBBdHRlbXB0IHRvIHJlYWQgYSBkYXRhIGF0dHJpYnV0ZSB2YWx1ZSwgcmV0dXJuaW5nIHVuZGVmaW5lZCBpZiBub25lIGlzIGZvdW5kXHJcbiAgICAgKiBAcGFyYW0geyp9IGdyaWRJdGVtIGEgTXV1cmkuR3JpZEl0ZW1cclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBhdHRyaWJ1dGVOYW1lIHRoZSBuYW1lIG9mIHRoZSBkYXRhIGF0dHJpYnV0ZVxyXG4gICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW3Jlc3VzY2l0YXRvcl0gYW4gb3B0aW9uYWwgcmVzdXNjaXRhdGlvbiBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgZXhlY3V0ZWQgYmVmb3JlIHJldHVybmluZyB0aGUgdmFsdWVcclxuICAgICAqIEByZXR1cm5zIHsqfSBUaGUgcmF3LCByZXN1c2NpdGF0ZWQsIG9yIHVuZGVmaW5lZCB2YWx1ZSAoaWYgbm8gZGF0YSBhdHRyaWJ1dGUgd2FzIGZvdW5kIGJ5IHRoZSBzcGVjaWZpZWQgbmFtZSlcclxuICAgICAqL1xyXG4gICAgY29uc3QgZ2V0R3JpZEl0ZW1EYXRhQXR0cmlidXRlID0gKGdyaWRJdGVtLCBhdHRyaWJ1dGVOYW1lLCByZXN1c2NpdGF0b3IpID0+IHtcclxuICAgICAgICBpZiAoZ3JpZEl0ZW0gJiYgYW5ndWxhci5pc0Z1bmN0aW9uKGdyaWRJdGVtLmdldEVsZW1lbnQpKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gZ3JpZEl0ZW0uZ2V0RWxlbWVudCgpLmRhdGFzZXRbYXR0cmlidXRlTmFtZV07XHJcbiAgICAgICAgICAgIHJldHVybiBhbmd1bGFyLmlzRnVuY3Rpb24ocmVzdXNjaXRhdG9yKSA/IHJlc3VzY2l0YXRvcih2YWx1ZSkgOiB2YWx1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgIH07XHJcblxyXG4gICAgdmFyIG5hbWUgPSAnbXV1cmlkZW1vLmNvbXBvbmVudHMubXV1cmlHcmlkLmNvbnRyb2xsZXInO1xyXG4gICAgdmFyIGluamVjdCA9IFsnJGVsZW1lbnQnLCAnJGxvZyddO1xyXG5cclxuICAgIGZ1bmN0aW9uIE11dXJpR3JpZCgkZWxlbWVudCwgJGxvZykge1xyXG4gICAgICAgIHRoaXMuY2FuRHJhZyA9IHRydWU7XHJcbiAgICAgICAgdGhpcy5lZGl0QnV0dG9uVGV4dCA9ICdEaXNhYmxlIEVkaXQgTW9kZSc7XHJcbiAgICAgICAgdGhpcy5hdmFpbGFibGVHcmlkcyA9IFtdO1xyXG5cclxuICAgICAgICB0aGlzLiRvbkluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgICAgIC8vc2V0IHVwIHRoZSBtdXVyaSBncmlkLCB1c2luZyB0aGUgZ3JpZCBlbGVtZW50IGFzIHRoZSBiYXNlIFxyXG4gICAgICAgICAgICB0aGlzLmdyaWQgPSBuZXcgTXV1cmkoJGVsZW1lbnRbMF0ucXVlcnlTZWxlY3RvcignLmRhc2hib2FyZF9fZ3JpZCcpLCB7XHJcbiAgICAgICAgICAgICAgICBpdGVtczogJy5pdGVtJywgLy9pbmNsdWRlIGFsbCBvZiB0aGUgaXRlbXMgZm9yIHRoZSBncmlkXHJcbiAgICAgICAgICAgICAgICBkcmFnRW5hYmxlZDogdGhpcy5jYW5EcmFnLCAvL21ha2Ugc3VyZSB5b3UgY2FuIGRyYWdcclxuICAgICAgICAgICAgICAgIGRyYWdTb3J0OiAoKT0+e1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmF2YWlsYWJsZUdyaWRzO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIGRyYWdTdGFydFByZWRpY2F0ZTogKGl0ZW0sIGV2ZW50KSA9PiB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vaWYgZHJhZ2dpbmcgaXMgZGlzYWJsZWQgdGhlbiBwcmV2ZW50IHRoZSBkcmFnXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmNhbkRyYWcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy9pZiBkcmFnIGlzIGVuYWJsZWQgdGhlbiBkbyB0aGUgZGVmYXVsdFxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBNdXVyaS5JdGVtRHJhZy5kZWZhdWx0U3RhcnRQcmVkaWNhdGUoaXRlbSwgZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIGxheW91dDoge1xyXG4gICAgICAgICAgICAgICAgICAgIGZpbGxHYXBzOiB0cnVlIC8vdGVsbHMgdGhlIGRlZmF1bHQgbGF5b3V0IHRvIG5vdCBsZWF2ZSBnYXBzIHdoZW5ldmVyIHBvc3NpYmxlXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB0aGlzLmdyaWQub24oJ3JlbW92ZScsIChpdGVtcykgPT4ge1xyXG4gICAgICAgICAgICAgICAgaXRlbXMuZm9yRWFjaChncmlkSXRlbSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaXRlbUlkID0gZ2V0R3JpZEl0ZW1EYXRhQXR0cmlidXRlKGdyaWRJdGVtLCAnZ3JpZEl0ZW1JZCcpO1xyXG4gICAgICAgICAgICAgICAgICAgIGl0ZW1Ib29rcy5jbGVhbnVwKGl0ZW1JZCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmF2YWlsYWJsZUdyaWRzLnB1c2godGhpcy5ncmlkKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB0aGlzLiRvbkRlc3Ryb3kgPSAoKSA9PiB7XHJcbiAgICAgICAgICAgIGlmKHRoaXMuZ3JpZCl7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBlbGVtZW50cyA9IHRoaXMuZ3JpZC5nZXRJdGVtcygpO1xyXG4gICAgICAgICAgICAgICAgaWYoZWxlbWVudHMgJiYgZWxlbWVudHMubGVuZ3RoKXtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmdyaWQucmVtb3ZlKGVsZW1lbnRzLCB7IHJlbW92ZUVsZW1lbnRzOiB0cnVlLCBsYXlvdXQ6IGZhbHNlIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHRoaXMuZ3JpZC5kZXN0cm95KCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmdyaWQgPSBudWxsO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgY29uc3QgY3JlYXRlR3JpZEl0ZW1Db250ZW50ID0gKHRpbGVDb250ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIC8vY3JlYXRlIHRoZSBjb250ZW50IGVsZW1lbnRcclxuICAgICAgICAgICAgY29uc3QgY29udGVudEVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdESVYnKTtcclxuICAgICAgICAgICAgaWYgKHRpbGVDb250ZW50LnR5cGUgPT0gJ1RleHQnKSB7XHJcbiAgICAgICAgICAgICAgICBjb250ZW50RWxlbWVudC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0aWxlQ29udGVudC5kYXRhKSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBtc2cgPSAnV2Ugb25seSBzdXBwb3J0IHRleHQgcmlnaHQgbm93JztcclxuICAgICAgICAgICAgICAgIGNvbnRlbnRFbGVtZW50LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKG1zZykpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGVudi5MT0dfTEVWRUwgPj0gY29uc3RhbnRzLkxPR19MRVZFTC5XQVJOKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJGxvZy53YXJuKG1zZyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGNvbnRlbnRFbGVtZW50O1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIFdyYXAgdGhlIHNwZWNpZmllZCBjb250ZW50IGludG8gYSBzZXQgb2YgZ3JpZCBpdGVtIERPTSBlbGVtZW50c1xyXG4gICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBoZWlnaHQgdGhlIHJlcXVlc3RlZCBoZWlnaHQgb2YgdGhlIGVsZW1lbnRcclxuICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gd2lkdGggdGhlIHJlcXVlc3RlZCB3aWR0aCBvZiB0aGUgZWxlbWVudFxyXG4gICAgICAgICAqIEBwYXJhbSAgey4uLkhUTUxFbGVtZW50fSBlbGVtZW50cyB0aGUgZWxlbWVudHMgdG8gd3JhcCBpbiB0aGlzIGdyaWQgaXRlbVxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGNvbnN0IHdyYXBHcmlkSXRlbUNvbnRlbnQgPSAoaGVpZ2h0LCB3aWR0aCwgLi4uZWxlbWVudHMpID0+IHtcclxuICAgICAgICAgICAgLy9nZXQgcGFyYW1zIGFuZCBzdG9yZSB0aGVtIGluIGxvY2FsIHZhcmlhYmxlc1xyXG4gICAgICAgICAgICBjb25zdCB0aWxlSGVpZ2h0ID0gaGVpZ2h0IHx8ICdYUyc7XHJcbiAgICAgICAgICAgIGNvbnN0IHRpbGVXaWR0aCA9IHdpZHRoIHx8ICdTJztcclxuICAgICAgICAgICAgY29uc3QgZ3JpZEl0ZW1JZCA9IGl0ZW1BdXRvSWQubmV4dCgpO1xyXG5cclxuICAgICAgICAgICAgLy9jcmVhdGUgdGhlIG5ldyB0aWxlIGFuZCBnaXZlIGl0IHRoZSBuZWNlc3NhcnkgY3NzIGNsYXNzZXNcclxuICAgICAgICAgICAgY29uc3QgZ3JpZEl0ZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdESVYnKTtcclxuICAgICAgICAgICAgZ3JpZEl0ZW0uY2xhc3NMaXN0LmFkZCgnaXRlbScsICd3JyArIHRpbGVXaWR0aCwgJ2gnICsgdGlsZUhlaWdodCk7XHJcblxyXG4gICAgICAgICAgICAvL2NyZWF0ZSB0aGUgZWxlbWVudCB0aGF0IHdpbGwgd3JhcCB0aGUgY29udGVudFxyXG4gICAgICAgICAgICBjb25zdCBncmlkSXRlbUlubmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnRElWJyk7XHJcbiAgICAgICAgICAgIGdyaWRJdGVtSW5uZXIuY2xhc3NMaXN0LmFkZCgnaXRlbS1jb250ZW50Jyk7XHJcblxyXG4gICAgICAgICAgICAvL2FwcGVuZCB0aGUgY29udGVudCB0byB0aGUgY29udGVudCB3cmFwcGVyLCB0aGVuIGFwcGVuZCB0aGUgY29udGVudCB3cmFwcGVyIHRvIHRoZSBuZXcgdGlsZVxyXG4gICAgICAgICAgICBncmlkSXRlbS5hcHBlbmRDaGlsZChncmlkSXRlbUlubmVyKTtcclxuICAgICAgICAgICAgZ3JpZEl0ZW0uZGF0YXNldC5ncmlkSXRlbUlkID0gZ3JpZEl0ZW1JZDtcclxuXHJcbiAgICAgICAgICAgIC8vIGFkZCBhbGwgc3VwcGxpZWQgZWxlbWVudHMgdG8gdGhlIGlubmVyIG5vZGVcclxuICAgICAgICAgICAgZWxlbWVudHMuZm9yRWFjaChlID0+IGdyaWRJdGVtSW5uZXIuYXBwZW5kQ2hpbGQoZSkpO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIHJvb3Q6IGdyaWRJdGVtLFxyXG4gICAgICAgICAgICAgICAgaW5uZXI6IGdyaWRJdGVtSW5uZXIsXHJcbiAgICAgICAgICAgICAgICBpZDogZ3JpZEl0ZW1JZFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGNvbnN0IGJ1aWxkTmV3R3JpZEl0ZW0gPSAoaGVpZ2h0LCB3aWR0aCwgdGlsZUNvbnRlbnQpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgaGVpZ2h0QnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYnV0dG9uJyk7XHJcbiAgICAgICAgICAgIGhlaWdodEJ1dHRvbi5pbm5lclRleHQgPSAnQ2hhbmdlIGhlaWdodCc7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBjb250ZW50ID0gY3JlYXRlR3JpZEl0ZW1Db250ZW50KHRpbGVDb250ZW50KTtcclxuICAgICAgICAgICAgY29uc3QgZ3JpZEl0ZW0gPSB3cmFwR3JpZEl0ZW1Db250ZW50KGhlaWdodCwgd2lkdGgsIGNvbnRlbnQsIGhlaWdodEJ1dHRvbik7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgaWQ6IGdyaWRJdGVtLmlkLFxyXG4gICAgICAgICAgICAgICAgcm9vdDogZ3JpZEl0ZW0ucm9vdCxcclxuICAgICAgICAgICAgICAgIGlubmVyOiBncmlkSXRlbS5pbm5lcixcclxuICAgICAgICAgICAgICAgIGJ1dHRvbjogaGVpZ2h0QnV0dG9uXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogU2V0IHRoZSBvcmRlciB2YWx1ZSBvbiB0aGUgcHJvdmlkZWQgZ3JpZCBpdGVtXHJcbiAgICAgICAgICogQHBhcmFtIHtudW1iZXJ9IG9yZGVyIFRoZSBzcGVjaWZpZWQgb3JkZXJcclxuICAgICAgICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fSBlbGVtZW50IFRoZSBncmlkIGl0ZW0gZWxlbWVudFxyXG4gICAgICAgICAqIEByZXR1cm5zIHt2b2lkfVxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGNvbnN0IHNldEdyaWRJdGVtT3JkZXIgPSAob3JkZXIsIGVsZW1lbnQpID0+IHtcclxuICAgICAgICAgICAgLy8gZGV0ZXJtaW5lIHRoZSBjb3JyZWN0IHZhbHVlIG9mIHRoZSBcIm9yZGVyXCIgYXJndW1lbnQgYmVjYXVzZSB0aGUgc3BlY2lmaWVkIHZhbHVlIHdhcyBub3QgdmFsaWRcclxuICAgICAgICAgICAgaWYgKG9yZGVyID09IG51bGwgfHwgaXNOYU4ob3JkZXIpIHx8ICFhbmd1bGFyLmlzTnVtYmVyKG9yZGVyKSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbnVtSXRlbXMgPSB0aGlzLmdyaWQuZ2V0SXRlbXMoKS5sZW5ndGg7XHJcbiAgICAgICAgICAgICAgICBvcmRlciA9IG51bUl0ZW1zIC0gMTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gc2V0IHRoZSBkYXRhLW9yZGVyIGF0dHJpYnV0ZSB2YWx1ZSBmb3IgdGhlIGdyaWQgaXRlbVxyXG4gICAgICAgICAgICBlbGVtZW50LmRhdGFzZXQub3JkZXIgPSAnJyArIG9yZGVyO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGNvbnN0IGF0dGFjaERlbW9SZXNpemUgPSAoZ3JpZEl0ZW0pID0+IHtcclxuICAgICAgICAgICAgLy8gc2V0dXAgdGhlIGRlbW8gcmVzaXplIGJ1dHRvblxyXG4gICAgICAgICAgICBjb25zdCByZXNpemVIYW5kbGVyID0gKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbmVlZHNSZWZyZXNoID0gaXRlbURpbWVuc2lvbnMuaW5jcmVtZW50R3JpZEl0ZW1IZWlnaHQoZ3JpZEl0ZW0ucm9vdCk7XHJcbiAgICAgICAgICAgICAgICBpZihuZWVkc1JlZnJlc2gpe1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZ3JpZC5yZWZyZXNoSXRlbXMoW2dyaWRJdGVtLnJvb3RdKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmdyaWQubGF5b3V0KCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIGdyaWRJdGVtLmJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHJlc2l6ZUhhbmRsZXIpO1xyXG4gICAgICAgICAgICBpdGVtSG9va3MucmVnaXN0ZXIoZ3JpZEl0ZW0uaWQsICgpID0+IHtcclxuICAgICAgICAgICAgICAgIGdyaWRJdGVtLmJ1dHRvbi5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIHJlc2l6ZUhhbmRsZXIpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBjb25zdCBzZXR1cERlbW9SZXNpemVEZXRlY3Rpb24gPSAoZ3JpZEl0ZW0pID0+IHtcclxuICAgICAgICAgICAgaWYodGhpcy5ncmlkVHlwZSA9PT0gJ2Rpc3BsYXktZ3JpZCcpe1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZ3Jvd2VyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICAgICAgICAgICAgICBncm93ZXIuY2xhc3NMaXN0LmFkZCgnZGFzaGJvYXJkX19oZWlnaHQtZGVtby1zdWJqZWN0Jyk7XHJcbiAgICBcclxuICAgICAgICAgICAgICAgIGdyaWRJdGVtLmlubmVyLmFwcGVuZENoaWxkKGdyb3dlcik7XHJcbiAgICBcclxuICAgICAgICAgICAgICAgIGNvbnN0IHdhdGNoZXIgPSBuZXcgRWxlbWVudFNpemVXYXRjaGVyKGdyb3dlcik7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzdWJzY3JpcHRpb24gPSB3YXRjaGVyLndhdGNoKCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZihncmlkSXRlbS5pbm5lci5zY3JvbGxIZWlnaHQgPiBncmlkSXRlbS5pbm5lci5vZmZzZXRIZWlnaHQpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuZWVkc1JlZnJlc2ggPSBpdGVtRGltZW5zaW9ucy5zZXRCZXN0SGVpZ2h0KGdyaWRJdGVtLnJvb3QsIGdyaWRJdGVtLmlubmVyLnNjcm9sbEhlaWdodCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKG5lZWRzUmVmcmVzaCl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdyaWQucmVmcmVzaEl0ZW1zKFtncmlkSXRlbS5yb290XSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdyaWQubGF5b3V0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIGl0ZW1Ib29rcy5yZWdpc3RlcihncmlkSXRlbS5pZCwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIHdhdGNoZXIuZGVzdHJveSgpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBjb25zdCBkZXN0cm95RHJhZ09iamVjdHMgPSAoKSA9PntcclxuICAgICAgICAgICAgdGhpcy5ncmlkLmdldEl0ZW1zKCkuZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgICAgICAgICAgIGlmICghaXRlbS5fZHJhZykgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgaXRlbS5fZHJhZy5kZXN0cm95KCk7XHJcbiAgICAgICAgICAgICAgICBpdGVtLl9kcmFnID0gbnVsbDtcclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGNyZWF0ZURyYWdPYmplY3RzID0gKCkgPT57XHJcbiAgICAgICAgICAgIHRoaXMuZ3JpZC5nZXRJdGVtcygpLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoaXRlbS5fZHJhZykgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgaXRlbS5fZHJhZyA9IG5ldyBNdXVyaS5JdGVtRHJhZyhpdGVtKTtcclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIGhlaWdodDogRXh0cmEgU21hbGwsIFNtYWxsLCBNZWRpdW0sIExhcmdlLCBFeHRyYSBMYXJnZVxyXG4gICAgICAgICAqIHdpZHRoOiBTbWFsbCwgTWVkaXVtLCBMYXJnZVxyXG4gICAgICAgICAqIGNvbnRlbnQ6IFRoZSBjb250ZW50IHRvIGJlIGxvYWRlZC4gQW4gb2JqZWN0IHdpdGggdHlwZSBhbmQgZGF0YSBwcm9wZXJ0aWVzLlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHRoaXMuYWRkVGlsZSA9IChoZWlnaHQsIHdpZHRoLCBjb250ZW50LCBvcmRlciwgc3VzcGVuZExheW91dCkgPT4ge1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgdmFyIHRpbGVDb250ZW50ID0ge307XHJcbiAgICAgICAgICAgIGlmIChjb250ZW50KSB7XHJcbiAgICAgICAgICAgICAgICB0aWxlQ29udGVudCA9IGNvbnRlbnQ7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aWxlQ29udGVudCA9IHtcclxuICAgICAgICAgICAgICAgICAgICB0eXBlOiAnVGV4dCcsXHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YTogJ0R1bW15IERhdGEgVG8gRGlzcGxheSdcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGdyaWRJdGVtID0gYnVpbGROZXdHcmlkSXRlbShoZWlnaHQsIHdpZHRoLCB0aWxlQ29udGVudCk7XHJcbiAgICAgICAgICAgIHNldEdyaWRJdGVtT3JkZXIob3JkZXIsIGdyaWRJdGVtLnJvb3QpO1xyXG4gICAgICAgICAgICBhdHRhY2hEZW1vUmVzaXplKGdyaWRJdGVtKTtcclxuICAgICAgICAgICAgc2V0dXBEZW1vUmVzaXplRGV0ZWN0aW9uKGdyaWRJdGVtKTtcclxuICAgICAgICAgICAgXHJcblxyXG4gICAgICAgICAgICAvL2FjdHVhbGx5IGFkZCB0aGUgbmV3IHRpbGUgdG8gdGhlIG11dXJpIGdyaWQsIGF0IHRoZSBlbmQsIHdpdGhvdXQgcGVyZm9ybWluZyBsYXlvdXRcclxuICAgICAgICAgICAgdGhpcy5ncmlkLmFkZChncmlkSXRlbS5yb290LCB7XHJcbiAgICAgICAgICAgICAgICBpbmRleDogLTEsXHJcbiAgICAgICAgICAgICAgICBsYXlvdXQ6IGZhbHNlXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5ncmlkLnNvcnQoKGEsIGIpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG9yZGVyQSA9IGdldEdyaWRJdGVtRGF0YUF0dHJpYnV0ZShhLCAnb3JkZXInLCBwYXJzZUludCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBvcmRlckIgPSBnZXRHcmlkSXRlbURhdGFBdHRyaWJ1dGUoYiwgJ29yZGVyJywgcGFyc2VJbnQpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG9yZGVyQSAtIG9yZGVyQjtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAvLyBpZiB0aGUgbGF5b3V0IGlzIG5vdCBzdXNwZW5kZWQsIHBlcmZvcm0gbGF5b3V0IGFmdGVyIHRoZSBzb3J0XHJcbiAgICAgICAgICAgIGlmICghc3VzcGVuZExheW91dCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5ncmlkLmxheW91dCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgLy90b2dnbGUgaWYgeW91IGNhbiBkcmFnIGl0ZW1zIGluIHRoZSBncmlkXHJcbiAgICAgICAgdGhpcy50b2dnbGVFZGl0ID0gKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmNhbkRyYWcgPSAhdGhpcy5jYW5EcmFnO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5jYW5EcmFnKSB7XHJcbiAgICAgICAgICAgICAgICBjcmVhdGVEcmFnT2JqZWN0cygpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lZGl0QnV0dG9uVGV4dCA9ICdEaXNhYmxlIEVkaXQgTW9kZSc7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBkZXN0cm95RHJhZ09iamVjdHMoKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZWRpdEJ1dHRvblRleHQgPSAnRW5hYmxlIEVkaXQgTW9kZSc7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIE11dXJpR3JpZC4kaW5qZWN0ID0gaW5qZWN0O1xyXG4gICAgTXV1cmlHcmlkLmNvbnRyb2xsZXJOYW1lID0gbmFtZTtcclxuICAgIHJldHVybiBNdXVyaUdyaWQ7XHJcbn0pOyJdfQ==
